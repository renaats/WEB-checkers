<!DOCTYPE html>
<html lang="en-US">
	<head>
		<style>
			.white-piece, .black-piece, .white-king, .black-king {
				pointer-events: none;
				height: 60px;
				width: auto; 
				display: block;
				margin-left: auto;
				margin-right: auto;	
				margin-top: 7.5px;
				margin-bottom: auto;
			}
			.white-piece {
				content: url("images/White.png");
			}
			.black-piece {
				content: url("images/Black.png");
			}
			.white-king {
				content: url("images/White-king.png");
			}
			.black-king {
				content: url("images/Black-king.png");
			}

			.board {
				width: 600px;
				height: 600px;
        		display: table-cell;
			}
			.white, .black {
				float: left;
				width: 75px;
				height: 75px;
			}
			.white {
				background-image: url("images/white wood.jpg");
			}
			.black {
				background-image: url("images/dark wood.jpg");
			}

			#chat {
				height: 500px;
				border: 5px solid gray;
			}
		</style>
	</head>

    <body style="background-color: #c3c3c3">
		<div style="float: left">
			<div class="board">
				<!-- Row 1 -->
				<div class="white"></div>
				<div class="black" data-row="1" data-column="2" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="4" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="6" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="8" data-piece="true"><img class="black-piece"></div>

				<!-- Row 2 -->
				<div class="black" data-row="2" data-column="1" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="3" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="5" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="7" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				
				<!-- Row 3 -->
				<div class="white"></div>
				<div class="black" data-row="3" data-column="2" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="4" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="6" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="8" data-piece="true"><img class="black-piece"></div>

				<!-- Row 4 -->
				<div class="black" data-row="4" data-column="1" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="3" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="5" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="7" data-piece="false"></div>
				<div class="white"></div>

				<!-- Row 5 -->
				<div class="white"></div>
				<div class="black" data-row="5" data-column="2" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="4" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="6" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="8" data-piece="false"></div>
				
				<!-- Row 6 -->
				<div class="black" data-row="6" data-column="1" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="3" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="5" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="7" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				
				<!-- Row 7 -->
				<div class="white"></div>
				<div class="black" data-row="7" data-column="2" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="4" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="6" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="8" data-piece="true"><img class="white-piece"></div>
				
				<!-- Row 8 -->
				<div class="black" data-row="8" data-column="1" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="3" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="5" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="7" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
			</div>

		</div>
		<div style="float: right" width=auto>
			<div id="chat" style="height: 500px"></div>

			<br>
			<form id="submit-text">
				Please input your message:  
				<input id="message-text" type="text"> <input type="submit" value="Send">
			</form>
		</div>
		<main>
			The game state is: <span id="game-state"></span><br>
			You are player <span id="player-type"></span><br>
			Your color is <span id="color"></span>
		</main>
		

		<script src="/javascripts/messages.js"></script>
		<script>
			let board = document.getElementsByClassName("board")[0];
			let color = null;
			let playerType = null;
			let gameState = null;
			let from = null;
			let myTurn = null;
			let isJump = false;
			let haveToJump = false;
			Array.from(board.children).forEach(function(cell) {
				cell.onclick = function(elem) {
					if (elem.target.getAttribute("data-piece") === "true") {
						from = elem.target;
						console.log(from);
					}
					else {
						let move = isLegalMove(from, elem.target, 1);
						console.log(from);
						console.log(move);
						console.log(haveToJump);
						if (from && move.legal && (!haveToJump || move.isJump)) {
							Messages.O_MOVE_MADE.data.from = {
								row: from.getAttribute("data-row"),
								column: from.getAttribute("data-column")
							};
							Messages.O_MOVE_MADE.data.to = {
								row: elem.target.getAttribute("data-row"),
								column: elem.target.getAttribute("data-column")
							};
							isJump = move.isJump;
							haveToJump = false;
							socket.send(JSON.stringify(Messages.O_MOVE_MADE));
							from = null;
						}
					}
				}
			});

			function isLegalMove(from, to, remove) {
				let toRow = parseInt(to.getAttribute("data-row"));
				let toColumn = parseInt(to.getAttribute("data-column"));
				let fromRow = parseInt(from.getAttribute("data-row"));
				let fromColumn = parseInt(from.getAttribute("data-column"));
				
				let legal = 0;
				if(isOnBoard(fromRow, fromColumn) && isOnBoard(toRow, toColumn) && to.getAttribute("data-piece") == "false") {
					legal = 1;
				}
				let jump = 0; 
				if ((toRow + toColumn) % 2 != 1) {
					legal = 0;
				}
				if (from.children[0].getAttribute("class") == "white-piece" && 
					color == "white") {
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) > 2) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 1 && haveToJump) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 2) {
						let midRow = ((fromRow + toRow) / 2).toString();
						let midColumn = ((fromColumn + toColumn) / 2).toString();
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
						if (cell.getAttribute("data-piece") === "false") {
							legal = 0;
						}
						else if (cell.innerHTML === '<img class="black-piece">' || cell.innerHTML === '<img class="black-king">') {
							if (remove) {
								Messages.O_TAKE_PIECE.data = {
									row: midRow,
									column: midColumn
								};	
								socket.send(JSON.stringify(Messages.O_TAKE_PIECE));
								jump = 1;
							}
						}
						else {
							legal = 0;
						}
					}
					else if (toRow >= fromRow) {
						legal = 0;
					}
					
				}
				else if (from.children[0].getAttribute("class") == "black-piece" &&
					color == "black") {
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) > 2) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 1 && haveToJump) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 2) {
						let midRow = ((fromRow + toRow) / 2).toString();
						let midColumn = ((fromColumn + toColumn) / 2).toString();
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
						if (cell.getAttribute("data-piece") === "false") {
							legal = 0;
						}				
						else if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
							if (remove) {
								Messages.O_TAKE_PIECE.data = {
									row: midRow,
									column: midColumn
								};
								socket.send(JSON.stringify(Messages.O_TAKE_PIECE));
								jump = 1;
							}
						}
						else {
							legal = 0;
						}
					}
					else if (toRow <= fromRow) {
						legal = 0;
					}
				}
				//Black king
				else if (from.children[0].getAttribute("class") == "black-king" &&
					color == "black") {
					let csign = 1;
					let rsign = 1;
					if(fromRow > toRow) {
						rsign=-1;
					}
					if(fromColumn>toColumn) {
						csign=-1;
					}
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) >= 2) {
						let midRow = "";
						let midColumn="";
						let middlePieces = 0;
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0]; //unimportant
						let rr = fromRow + rsign;
						let cc = fromColumn + csign;
						while (rr != toRow && cc != toColumn) {
							midRow = rr.toString();
							midColumn = cc.toString();
							cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
							
							if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
								middlePieces++;
							}
							if (cell.innerHTML === '<img class="black-piece">' || cell.innerHTML === '<img class="black-king">') {
								legal=0;
							}
							rr += rsign;
							cc += csign;
						}
						if(middlePieces>1) {
							legal=0;
						}
						else if(middlePieces == 1 && legal) {
							rr = fromRow + rsign;
							cc = fromColumn + csign;
							while (rr != toRow && cc != toColumn) {
								midRow=rr.toString();
								midColumn=cc.toString();
								if (remove) {
									Messages.O_TAKE_PIECE.data = {
										row: midRow,
										column: midColumn
									};
									socket.send(JSON.stringify(Messages.O_TAKE_PIECE));
								}
								jump = 1;
								/*cell= document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
								
								if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
									cell.innerHTML = "";
									cell.setAttribute("data-piece", "false");
								}*/
								rr += rsign;
								cc += csign;
							}
						}
						else if (haveToJump && remove) {
							legal = 0;
						}
					}
					else if (haveToJump && remove) {
						legal = 0;
					}
				}
				//White King
				else if (from.children[0].getAttribute("class") == "white-king" &&
				color == "white") {
					let csign = 1;
					let rsign = 1;
					if(fromRow > toRow) {
						rsign=-1;
					}
					if(fromColumn>toColumn) {
						csign=-1;
					}
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) >= 2) {
						let midRow = "";
						let midColumn="";
						let middlePieces = 0;
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0]; //unimportant
						let rr = fromRow + rsign;
						let cc = fromColumn + csign;
						while (rr != toRow && cc != toColumn) {
							midRow = rr.toString();
							midColumn = cc.toString();
							cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
							
							if (cell.innerHTML === '<img class="black-piece">' || cell.innerHTML === '<img class="black-king">') {
								middlePieces++;
							}
							if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
								legal=0;
							}
							rr += rsign;
							cc += csign;
						}
						if(middlePieces>1) {
							legal=0;
						}
						else if(middlePieces == 1 && legal) {
							rr = fromRow + rsign;
							cc = fromColumn + csign;
							while (rr != toRow && cc != toColumn) {
								midRow=rr.toString();
								midColumn=cc.toString();
								if (remove) {
									Messages.O_TAKE_PIECE.data = {
										row: midRow,
										column: midColumn
									};
									socket.send(JSON.stringify(Messages.O_TAKE_PIECE));
								}
								jump = 1;
								/*cell= document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
								
								if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
									cell.innerHTML = "";
									cell.setAttribute("data-piece", "false");
								}*/
								rr += rsign;
								cc += csign;
							}
						}
						else if (haveToJump && remove) {
							legal = 0;
						}
					}
					else if (haveToJump && remove) {
						legal = 0;
					}
				}
				else {
					legal = 0;
				}
				return {
					legal: legal,
					isJump: jump
				};
			}

			function isOnBoard(row, column) {
				if (row >= 1 && row <=8 && column >= 1 && column <= 8) {
					return true;
				}
				return false;
			}

			function canMove(cell) {
				let row = parseInt(cell.getAttribute("data-row"));
				let column = parseInt(cell.getAttribute("data-column"));
				let move = 0;
				if (isOnBoard(row+1, column+1) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row+1).toString()+'"][data-column="'+(column+1).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row+1, column-1) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row+1).toString()+'"][data-column="'+(column-1).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row-1, column+1) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row-1).toString()+'"][data-column="'+(column+1).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row-1, column-1) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row-1).toString()+'"][data-column="'+(column-1).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row+2, column+2) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row+2).toString()+'"][data-column="'+(column+2).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row+2, column-2) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row+2).toString()+'"][data-column="'+(column-2).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row-2, column+2) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row-2).toString()+'"][data-column="'+(column+2).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				if (isOnBoard(row-2, column-2) && isLegalMove(cell, document.querySelectorAll('[data-row="'+(row-2).toString()+'"][data-column="'+(column-2).toString()+'"]')[0], 0).legal) {
					move = 1;
				}
				return move;
			}

			function forceJump(cell){
				if (cell.innerHTML == '<img class="' + color + '-piece">' || cell.innerHTML == '<img class="' + color + '-king">') {
					let row = parseInt(cell.getAttribute("data-row"));
					let column = parseInt(cell.getAttribute("data-column"));
					if (isOnBoard(row + 2, column + 2)) {
						let target = document.querySelectorAll('[data-row="'+(row+2).toString()+'"][data-column="'+(column+2).toString()+'"]')[0];
						let over = document.querySelectorAll('[data-row="'+(row+1).toString()+'"][data-column="'+(column+1).toString()+'"]')[0];
						if (target.getAttribute("data-piece") == "false" && over.getAttribute("data-piece") == "true" &&
						over.innerHTML != '<img class="' + color + '-piece">' && over.innerHTML != '<img class="' + color + '-king">' ) {
							haveToJump = true;
						}
					}
					if (isOnBoard(row + 2, column - 2)) {
						let target = document.querySelectorAll('[data-row="'+(row+2).toString()+'"][data-column="'+(column-2).toString()+'"]')[0];
						let over = document.querySelectorAll('[data-row="'+(row+1).toString()+'"][data-column="'+(column-1).toString()+'"]')[0];
						if (target.getAttribute("data-piece") == "false" && over.getAttribute("data-piece") == "true" &&
						over.innerHTML != '<img class="' + color + '-piece">' && over.innerHTML != '<img class="' + color + '-king">' ) {
							haveToJump = true;
						}
					}
					if (isOnBoard(row - 2, column + 2)) {
						let target = document.querySelectorAll('[data-row="'+(row-2).toString()+'"][data-column="'+(column+2).toString()+'"]')[0];
						let over = document.querySelectorAll('[data-row="'+(row-1).toString()+'"][data-column="'+(column+1).toString()+'"]')[0];
						if (target.getAttribute("data-piece") == "false" && over.getAttribute("data-piece") == "true" &&
						over.innerHTML != '<img class="' + color + '-piece">' && over.innerHTML != '<img class="' + color + '-king">' ) {
							haveToJump = true;
						}
					}
					if (isOnBoard(row - 2, column - 2)) {
						let target = document.querySelectorAll('[data-row="'+(row-2).toString()+'"][data-column="'+(column-2).toString()+'"]')[0];
						let over = document.querySelectorAll('[data-row="'+(row-1).toString()+'"][data-column="'+(column-1).toString()+'"]')[0];
						if (target.getAttribute("data-piece") == "false" && over.getAttribute("data-piece") == "true" &&
						over.innerHTML != '<img class="' + color + '-piece">' && over.innerHTML != '<img class="' + color + '-king">' ) {
							haveToJump = true;
						}
					}
				}
				if (cell.innerHTML == '<img class="' + color + '-king">') {
					let row = parseInt(cell.getAttribute("data-row"));
					let column = parseInt(cell.getAttribute("data-column"));
					for (let i = 3; i <= 7; i++) {
						if (isOnBoard(row + i, column + i)) {
							let target = document.querySelectorAll('[data-row="'+(row+i).toString()+'"][data-column="'+(column+i).toString()+'"]')[0];
							if (isLegalMove(cell, target, 0).legal && isLegalMove(cell, target, 0).isJump) {
								haveToJump = true;
							}
						}
						if (isOnBoard(row + i, column - i)) {
							let target = document.querySelectorAll('[data-row="'+(row+i).toString()+'"][data-column="'+(column-i).toString()+'"]')[0];
							if (isLegalMove(cell, target, 0).legal && isLegalMove(cell, target, 0).isJump) {
								haveToJump = true;
							}
						}
						if (isOnBoard(row - i, column + i)) {
							let target = document.querySelectorAll('[data-row="'+(row-i).toString()+'"][data-column="'+(column+i).toString()+'"]')[0];
							if (isLegalMove(cell, target, 0).legal && isLegalMove(cell, target, 0).isJump) {
								haveToJump = true;
							}
						}
						if (isOnBoard(row - i, column - i)) {
							let target = document.querySelectorAll('[data-row="'+(row-i).toString()+'"][data-column="'+(column-i).toString()+'"]')[0];
							if (isLegalMove(cell, target, 0).legal && isLegalMove(cell, target, 0).isJump) {
								haveToJump = true;
							}
						}	
					}
				}
			}

			

			var socket = new WebSocket("ws://localhost:3001");
			var message;

			
			let element = document.getElementById("submit-text");
			element.addEventListener("submit", function(event) {
				let messageText = document.getElementById("message-text").value;
				event.preventDefault();
				console.log(event);
				console.log(messageText);
				Messages.O_MESSAGE.data = color.charAt(0).toUpperCase() + color.slice(1) + ": " + messageText;
				document.getElementById("message-text").value = "";
				socket.send(JSON.stringify(Messages.O_MESSAGE));
			});

			socket.onopen = function(){

			};
			socket.onmessage = function(event){
				message = JSON.parse(event.data);
				console.log(document.getElementById("player-type").innerHTML + ": " + event.data);
				if (message.type == "PLAYER-TYPE") {
					playerType = message.data;
					document.getElementById("player-type").innerHTML = playerType;
					if (message.data == "A") {
						color = "white";
					}
					else {
						color = "black";
					}
					document.getElementById("color").innerHTML = color;
				}
				if (message.type == "GAME-STATE") {
					gameState = message.data;
					document.getElementById("game-state").innerHTML = gameState;
				}
				if (message.type == "START-TURN") {
					haveToJump = false;
					myTurn = true;
					Array.from(board.children).forEach(function(cell) {
						forceJump(cell);
					});
					console.log(playerType + " turn started, forceJump: " + haveToJump);

					
					let hasLost = 1;
					Array.from(board.children).forEach(function(cells) {
						if ((cells.innerHTML == '<img class="' + color + '-piece">'||cells.innerHTML == '<img class="' + color + '-king">')
						&& canMove(cells)) {
							hasLost = 0;
						}
					});
					if (hasLost) {
						Messages.O_GAME_WON_BY.data = playerType;
						socket.send(JSON.stringify(Messages.O_GAME_WON_BY));
					}
				}
				if (message.type == "TAKE-PIECE") {
					let cell = document.querySelectorAll('[data-row="'+message.data.row+'"][data-column="'+message.data.column+'"]')[0];
					cell.innerHTML = "";
					cell.setAttribute("data-piece", "false");
				}
				if (message.type == "MOVE-MADE") {
					let from = document.querySelectorAll('[data-row="'+message.data.from.row+'"][data-column="'+message.data.from.column+'"]')[0];
					let to = document.querySelectorAll('[data-row="'+message.data.to.row+'"][data-column="'+message.data.to.column+'"]')[0];
					to.innerHTML = from.innerHTML;
					from.innerHTML = "";
					to.setAttribute("data-piece", "true");
					from.setAttribute("data-piece", "false");
					console.log(to.getAttribute("data-row") + " " + to.children[0].getAttribute("class"));
					if (to.getAttribute("data-row") == "1" && to.children[0].getAttribute("class") == "white-piece") {
						to.children[0].setAttribute("class", "white-king");
					}
					if (to.getAttribute("data-row") == "8" && to.children[0].getAttribute("class") == "black-piece") {
						to.children[0].setAttribute("class", "black-king");
					}
					console.log(to.getAttribute("data-row") + " " + to.children[0].getAttribute("class"));

					if (myTurn == true) {
						forceJump(to);
						if (!haveToJump || !isJump) {
							socket.send(Messages.S_END_TURN);
							myTurn = false;
						}	
					}
					else {
						isJump = false;
					}
				}
				if (message.type == "MESSAGE") {
					let chat = document.getElementById("chat");
					chat.innerHTML += message.data + "<br>";
					console.log(chat.innerHTML);
				}
			};
		</script>
	</body>
</html>