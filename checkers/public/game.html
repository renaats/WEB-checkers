<!DOCTYPE html>
<html lang="en-US">
	<head>
		<style>
			.white-piece, .black-piece, .white-king, .black-king {
				pointer-events: none;
				height: 60px; 
				display: block;
				margin-left: auto;
				margin-right: auto;	
				margin-top: 7.5px;
				margin-bottom: auto;
			}
			.white-piece {
				content: url(images/White.png);
			}
			.black-piece {
				content: url(images/Black.png);
			}
			.white-king {
				content: url(images/White-king.png);
			}
			.black-king {
				content: url(images/Black-king.png);
			}

			.board {
				width: 600px;
				height: 600px;
        		display: table-cell;
			}
			.white, .black {
				float: left;
				width: 75px;
				height: 75px;
			}
			.white {
				background-image: url("images/white wood.jpg");
			}
			.black {
				background-image: url("images/dark wood.jpg");
			}

			.chat {
				height: 500px;
				border: 5px solid gray;
			}
		</style>
	</head>

    <body style="background-color: #c3c3c3">
		<div style="float: left">
			<div class="board">
				<!-- Row 1 -->
				<div class="white"></div>
				<div class="black" data-row="1" data-column="2" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="4" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="6" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="1" data-column="8" data-piece="true"><img class="black-piece"></div>

				<!-- Row 2 -->
				<div class="black" data-row="2" data-column="1" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="3" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="5" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="2" data-column="7" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				
				<!-- Row 3 -->
				<div class="white"></div>
				<div class="black" data-row="3" data-column="2" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="4" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="6" data-piece="true"><img class="black-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="3" data-column="8" data-piece="true"><img class="black-piece"></div>

				<!-- Row 4 -->
				<div class="black" data-row="4" data-column="1" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="3" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="5" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="4" data-column="7" data-piece="false"></div>
				<div class="white"></div>

				<!-- Row 5 -->
				<div class="white"></div>
				<div class="black" data-row="5" data-column="2" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="4" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="6" data-piece="false"></div>
				<div class="white"></div>
				<div class="black" data-row="5" data-column="8" data-piece="false"></div>
				
				<!-- Row 6 -->
				<div class="black" data-row="6" data-column="1" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="3" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="5" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="6" data-column="7" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				
				<!-- Row 7 -->
				<div class="white"></div>
				<div class="black" data-row="7" data-column="2" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="4" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="6" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="7" data-column="8" data-piece="true"><img class="white-piece"></div>
				
				<!-- Row 8 -->
				<div class="black" data-row="8" data-column="1" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="3" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="5" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
				<div class="black" data-row="8" data-column="7" data-piece="true"><img class="white-piece"></div>
				<div class="white"></div>
			</div>

		</div>
		<div style="float: right" width=auto>
			<div class="chat" style="height: 500px"></div>

			<br>
			<form>
				Please input your message:  
				<input type="text" name="firstname"> <input type="submit" value="Send">
			</form>
		</div>
		<main>
			The game state is: <span id="game-state"></span><br>
			You are player <span id="player-type"></span><br>
			Your color is <span id="color"></span>
		</main>
		

		<script src="/javascripts/messages.js"></script>
		<script>
			let board = document.getElementsByClassName("board")[0];
			let from = null;
			let haveToJump = false;
			Array.from(board.children).forEach(function(cell) {
				cell.onclick = function(elem) {
					if (elem.target.getAttribute("data-piece") === "true") {
						from = elem.target;
						console.log(from);
					}
					else if (from && isLegalMove(from, elem.target)) {
						elem.target.innerHTML = from.innerHTML;
						from.innerHTML = "";
						elem.target.setAttribute("data-piece", "true");
						from.setAttribute("data-piece", "false");
						Messages.O_MOVE_MADE.from = {
							row: from.getAttribute("data-row"),
							column: from.getAttribute("data-column")
						};
						Messages.O_MOVE_MADE.to = {
							row: elem.target.getAttribute("data-row"),
							column: elem.target.getAttribute("data-column")
						};
						socket.send(JSON.stringify(Messages.O_MOVE_MADE));
						from = null;
					}
				}
			});

			function isLegalMove(from, to) {
				let toRow = parseInt(to.getAttribute("data-row"));
				let toColumn = parseInt(to.getAttribute("data-column"));
				let fromRow = parseInt(from.getAttribute("data-row"));
				let fromColumn = parseInt(from.getAttribute("data-column"));
				
				let legal = 1;
				legal = legal && (toRow + toColumn) % 2 === 1;
				if (from.children[0].getAttribute("class") == "white-piece" && 
					document.getElementById("color").innerHTML == "white" && 
					document.getElementById("game-state").innerHTML == "a move") {
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) > 2) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 1 && haveToJump) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 2) {
						let midRow = ((fromRow + toRow) / 2).toString();
						let midColumn = ((fromColumn + toColumn) / 2).toString();
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
						if (cell.getAttribute("data-piece") === "false") {
							legal = 0;
						}
						else if (cell.innerHTML === '<img class="black-piece">' || cell.innerHTML === '<img class="black-king">') {
							cell.innerHTML = "";
							cell.setAttribute("data-piece", "false");
						}
						else {
							legal = 0;
						}
					}
					else if (toRow >= fromRow) {
						legal = 0;
					}
					
				}
				else if (from.children[0].getAttribute("class") == "black-piece" &&
					document.getElementById("color").innerHTML == "black" && 
					document.getElementById("game-state").innerHTML == "b move") {
					if (Math.abs(toColumn - fromColumn) !== Math.abs(toRow - fromRow)) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) > 2) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 1 && haveToJump) {
						legal = 0;
					}
					else if (Math.abs(fromRow - toRow) == 2) {
						let midRow = ((fromRow + toRow) / 2).toString();
						let midColumn = ((fromColumn + toColumn) / 2).toString();
						let cell = document.querySelectorAll('[data-row="'+midRow+'"][data-column="'+midColumn+'"]')[0];
						if (cell.getAttribute("data-piece") === "false") {
							legal = 0;
						}
						else if (cell.innerHTML === '<img class="white-piece">' || cell.innerHTML === '<img class="white-king">') {
							cell.innerHTML = "";
							cell.setAttribute("data-piece", "false");
						}
						else {
							legal = 0;
						}
					}
					else if (toRow <= fromRow) {
						legal = 0;
					}
				}
				else {
					legal = 0;
				}
				return legal;
			}
			var socket = new WebSocket("ws://localhost:3001");
			var message;

			socket.onopen = function(){
				socket.send(JSON.stringify(document.getElementById("hello")));
			};
			socket.onmessage = function(event){
				//console.log(message);
				message = JSON.parse(event.data);
				if (message.type == "PLAYER-TYPE") {
					document.getElementById("player-type").innerHTML = message.data;
					if (message.data == "A") {
						document.getElementById("color").innerHTML = "white";
					}
					else {
						document.getElementById("color").innerHTML = "black";
					}
				}
				if (message.type == "GAME-STATE") {
					document.getElementById("game-state").innerHTML = message.data;
				}
				if (message.type == "MOVE-MADE") {
					message.to.innerHTML = message.from.innerHTML;
					message.from.innerHTML = "";
					message.to.setAttribute("data-piece", "true");
					message.from.setAttribute("data-piece", "false");
					message.from = null;
					message.to = null;
				}
			};
		</script>
	</body>
</html>